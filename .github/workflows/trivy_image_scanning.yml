name: Auto Image Scan

on:
  schedule:
    - cron: "0 * * * *" # Runs every hour
  workflow_dispatch: # Allows manual trigger

jobs:
  scan-image:
    name: Scan Latest GHCR Image with Trivy
    runs-on: ubuntu-latest

    steps:
      - name: Log in to GitHub Container Registry (GHCR)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Fetch Latest Image SHA from GHCR
        run: |
          echo "🔍 Fetching latest image SHA from GitHub Packages API..."

          RESPONSE=$(curl -s -H "Accept: application/vnd.github+json" \
                            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                            "https://api.github.com/users/suriya1776/packages/container/adservice/versions")

          echo "Raw Response: $RESPONSE"

          # Check if the response is empty or contains an error
          if [[ -z "$RESPONSE" || "$RESPONSE" == *"message"* ]]; then
            echo "❌ Error: Package not found or API request failed."
            exit 1
          fi

          # Extract latest image SHA safely
          LATEST_SHA=$(echo "$RESPONSE" | jq -r '.[0].name // empty')

          if [[ -z "$LATEST_SHA" ]]; then
            echo "❌ Error: No valid image SHA found!"
            exit 1
          fi

          echo "✅ Latest Image SHA: $LATEST_SHA"
          echo "LATEST_SHA=$LATEST_SHA" >> $GITHUB_ENV

      - name: Run Trivy Scan on Latest GHCR Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "ghcr.io/suriya1776/adservice@${{ env.LATEST_SHA }}"
          format: "table"
          severity: "HIGH,CRITICAL"
          exit-code: 1
