- name: Fetch Latest Image SHA from GHCR
  run: |
    IMAGE_REPO="ghcr.io/suriya1776/adservice"
    RESPONSE=$(curl -s -H "Accept: application/vnd.github+json" \
                      -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                      "https://api.github.com/users/suriya1776/packages/container/adservice/versions")

    echo "Raw Response: $RESPONSE"

    # Extract latest image SHA
    LATEST_SHA=$(echo "$RESPONSE" | jq -r '.[0].name')

    if [[ -z "$LATEST_SHA" ]]; then
      echo "❌ ERROR: No tags found! Using SHA instead."
      exit 1
    fi

    IMAGE_NAME="${IMAGE_REPO}@${LATEST_SHA}"
    echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
    echo "✅ Scanning Image: ${IMAGE_NAME}"
