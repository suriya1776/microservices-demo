name: Auto Image Scan

on:
  schedule:
    - cron: "0 * * * *" # Runs every hour
  workflow_dispatch: # Allows manual trigger

jobs:
  scan-image:
    name: Scan Latest GHCR Image with Trivy
    runs-on: ubuntu-latest

    steps:
      - name: Log in to GitHub Container Registry (GHCR)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Fetch Latest Image Tag from GHCR
        run: |
          IMAGE_REPO="ghcr.io/suriya1776/adservice"

          # Fetch tags list and get the latest one
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/suriya1776/adservice/tags/list")

          echo "🔍 Raw API Response: $RESPONSE"

          LATEST_TAG=$(echo "$RESPONSE" | jq -r '.tags | sort | last')

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            echo "⚠️ No valid image tag found!"
            exit 1
          fi

          echo "✅ Using latest image tag: $LATEST_TAG"
          echo "IMAGE_NAME=${IMAGE_REPO}:${LATEST_TAG}" >> $GITHUB_ENV

      - name: Run Trivy Scan on Latest GHCR Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}
          format: "table"
          severity: "HIGH,CRITICAL"
          exit-code: 1
