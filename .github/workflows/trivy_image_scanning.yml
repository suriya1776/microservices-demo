name: Auto Image Scan

on:
  schedule:
    - cron: "0 * * * *" # Runs every hour
  workflow_dispatch:

jobs:
  scan-image:
    runs-on: ubuntu-latest

    steps:
      - name: Log in to GitHub Container Registry (GHCR)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Fetch Latest Image SHA from GHCR
        run: |
          IMAGE_REPO="ghcr.io/suriya1776/adservice"
          
          # 🔍 Fetch latest image versions
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/suriya1776/packages/container/adservice/versions")

          echo "🔍 Raw API Response:"
          echo "$RESPONSE"

          # 🔹 Extract latest image SHA
          LATEST_SHA=$(echo "$RESPONSE" | jq -r '.[0].name')

          if [ -z "$LATEST_SHA" ] || [ "$LATEST_SHA" == "null" ]; then
            echo "⚠️ No SHA found! API response may be empty or incorrect."
            exit 1
          fi

          echo "✅ Latest SHA: $LATEST_SHA"
          echo "IMAGE_SHA=$LATEST_SHA" >> $GITHUB_ENV

      - name: Scan GHCR Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "ghcr.io/suriya1776/adservice@${{ env.IMAGE_SHA }}"
          format: "table"
          severity: "HIGH,CRITICAL"
          exit-code: 1
